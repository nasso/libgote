<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>State - libgote</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="expanded "><a href="../concepts.html"><strong aria-hidden="true">2.</strong> Concepts</a></li><li><ol class="section"><li class="expanded "><a href="../concepts/state.html" class="active"><strong aria-hidden="true">2.1.</strong> State</a></li><li class="expanded "><a href="../concepts/world-resource.html"><strong aria-hidden="true">2.2.</strong> World and Resource</a></li><li class="expanded "><a href="../concepts/entity-component.html"><strong aria-hidden="true">2.3.</strong> Entity and Component</a></li><li class="expanded "><a href="../concepts/system.html"><strong aria-hidden="true">2.4.</strong> System</a></li><li class="expanded "><a href="../concepts/dispatcher.html"><strong aria-hidden="true">2.5.</strong> Dispatcher</a></li><li class="expanded "><a href="../concepts/event_channel.html"><strong aria-hidden="true">2.6.</strong> Event channel</a></li><li class="expanded "><a href="../concepts/asset_format.html"><strong aria-hidden="true">2.7.</strong> Asset format</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">libgote</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#state" id="state">State</a></h1>
<h2><a class="header" href="#basics" id="basics">Basics</a></h2>
<p>As described in <a href="https://gamedevelopment.tutsplus.com/articles/how-to-build-a-jrpg-a-primer-for-game-developers--gamedev-6676#state">this article</a>, a state (or game-state) represents a
&quot;mode&quot; our game is in. For instance, we could separate an RPG in different
game states:</p>
<ul>
<li>A &quot;local map&quot; state where the player can move around a terrain</li>
<li>A &quot;world map&quot; state where a zoomed-out map of the world is displayed</li>
<li>A &quot;combat&quot; state for fights!</li>
<li>A &quot;pause menu&quot; state displaying the pause menu of the game</li>
<li>...</li>
</ul>
<p><img src="jrpg-states-and-transistions.png" alt="Different game states and the transitions between them" /></p>
<p>Essentially, every state has its own <code>start</code>, <code>stop</code> and <code>update</code> functions.</p>
<h3><a class="header" href="#usage" id="usage">Usage</a></h3>
<p>To create a state with the <code>libgote</code>, <strong>use <code>calloc</code></strong> to allocate a
<code>gt_state_t</code> structure and set the callback functions you care about:</p>
<pre><code class="language-c">gt_state_t *create_combat_state(void)
{
  gt_state_t *state = my_calloc(1, sizeof(gt_state_t));

  state-&gt;update = &amp;combat_state_update;
  return (state);
}
</code></pre>
<p>Of course, <code>update</code> isn't the only callback available to game states. Here is
a list of the most commonly used:</p>
<ul>
<li><strong>on_start</strong> - called when the state starts.</li>
<li><strong>on_stop</strong> - called when the state stops.</li>
<li><strong>update</strong> - called on every iteration of the game loop while the state is
active.</li>
<li><strong>destroy</strong> - called when the state is destroyed, use it to free the <code>self</code>
field.</li>
</ul>
<p>The <code>libgote</code> will safely ignore any callback set to <code>NULL</code>. This is why <strong>you
should use <code>calloc</code></strong> to allocate the <code>gt_state_t</code> structure (<code>calloc</code> ensures
all the allocated bytes are set to <code>NULL</code> or <code>0</code>).</p>
<p>The <code>self</code> field allows you to store arbitrary data associated with your state.
Its value is passed as an argument to all the callbacks. In most cases, you will
use it to keep a reference to data you want to clean-up when the state is
stopped:</p>
<pre><code class="language-c">/* Structure holding the data associated with the state */
struct combat_state {
  player_t *player;
};

/* Create the player when the state starts */
static void combat_state_on_start(void *ptr, gt_world_t *world)
{
  struct combat_state *self = ptr;

  self-&gt;player = player_create(world);
}

/* Remove the player when the state stops */
static void combat_state_on_stop(void *ptr, gt_world_t *world)
{
  struct combat_state *self = ptr;

  player_remove(self-&gt;player, world);
}

/* Create the state, its data structure, and set the callbacks */
gt_state_t *create_combat_state(void)
{
  gt_state_t *state = my_calloc(1, sizeof(gt_state_t));

  state-&gt;self = my_calloc(1, sizeof(struct combat_state));
  state-&gt;destroy = &amp;my_free;
  state-&gt;on_start = &amp;combat_state_on_start;
  state-&gt;on_stop = &amp;combat_state_on_stop;
  return (state);
}
</code></pre>
<p><strong>Make sure not to forget to set <code>state-&gt;destroy</code> to an appropriate freeing
function! If you don't do it, memory <em>WILL</em> leak!</strong></p>
<h2><a class="header" href="#state-machine" id="state-machine">State machine</a></h2>
<p>Game states are usually managed by something called a <strong>state machine</strong>. It is
the one responsible for calling the right function at every iteration of the
game loop. Only one state can be active at a time!</p>
<p><img src="jrpg-state-machine.gif" alt="The state machine calls the update function of the currently active state" /></p>
<p>The state machine is often implemented as a <a href="https://en.wikipedia.org/wiki/Stack_(abstract_data_type)">stack</a>, where states can be
pushed and popped. The state at the top of the stack is the <strong>active state</strong>.</p>
<p><img src="jrpg-state-stack.gif" alt="A game state beind pushed and then popped from the state machine" /></p>
<h2><a class="header" href="#transitions" id="transitions">Transitions</a></h2>
<p>A change in the state machine's stack is called a <strong>state transition</strong>. There
are 4 different kinds of transitions in the <code>libgote</code>:</p>
<ul>
<li><strong>Push transitions</strong> - a state is pushed on top of the stack: it becomes the
active state.</li>
<li><strong>Pop transitions</strong> - the state on top of the stack is removed (the state
below it, if any, becomes active).</li>
<li><strong>Switch transitions</strong> - the state on top of the stack is replaced with
another state.</li>
<li><strong>Quit transitions</strong> - all the states are removed from the stack, killing the
the state machine.</li>
</ul>
<p>As soon as the state stack becomes empty, the state machine is killed and the
game is effectively terminated.</p>
<h2><a class="header" href="#additionnal-callbacks" id="additionnal-callbacks">Additionnal callbacks</a></h2>
<p>In the <code>libgote</code>, states have actually 3 extra callbacks I didn't mention yet.
You might need them in some special cases:</p>
<ul>
<li><strong>on_pause</strong> - called when a state is pushed on top of the current one.</li>
<li><strong>on_resume</strong> - called when the state above gets popped.</li>
<li><strong>shadow_update</strong> - same as <code>update</code>, but is called on ALL the states in the
stack.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../concepts.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../concepts/world-resource.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../concepts.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../concepts/world-resource.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
